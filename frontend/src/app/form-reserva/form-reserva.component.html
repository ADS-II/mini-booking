<!-- Modal overlay -->
<div class="modal-overlay" (click)="cerrar()">

  <!-- Modal container -->
  <div class="modal-container" (click)="$event.stopPropagation()">

    <!-- Header -->
    <header class="modal-header">
      <h2 class="modal-title">Reservar {{ espacioNombre || 'Espacio' }}</h2>
      <button type="button" class="btn-close" (click)="cerrar()" aria-label="Cerrar">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </header>

    <!-- Body -->
    <div class="modal-body">
      <form (ngSubmit)="reservar()" #reservaForm="ngForm">

        <!-- Fechas -->
        <div class="form-section">
          <h3 class="section-title">Fechas de Reserva</h3>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="fechaInicio">
                Fecha de inicio
                <span class="required">*</span>
              </label>
              <input 
                type="date" 
                id="fechaInicio" 
                name="fechaInicio" 
                class="form-input"
                [class.input-valid]="getFieldStatus('fechaInicio') === 'valid'"
                [class.input-invalid]="getFieldStatus('fechaInicio') === 'invalid'"
                [(ngModel)]="fechaInicio"
                (blur)="marcarTocado('fechaInicio')"
                (change)="validarFormularioCompleto()"
                [min]="fechaMinima"
                [max]="fechaMaxima"
                required>
              <span class="error-message" *ngIf="touched.fechaInicio && errores.fechaInicio">
                {{ errores.fechaInicio }}
              </span>
            </div>

            <div class="form-group">
              <label class="form-label" for="fechaFin">
                Fecha de fin
                <span class="required">*</span>
              </label>
              <input 
                type="date" 
                id="fechaFin" 
                name="fechaFin" 
                class="form-input"
                [class.input-valid]="getFieldStatus('fechaFin') === 'valid'"
                [class.input-invalid]="getFieldStatus('fechaFin') === 'invalid'"
                [(ngModel)]="fechaFin"
                (blur)="marcarTocado('fechaFin')"
                (change)="validarFormularioCompleto()"
                [min]="fechaMinima"
                [max]="fechaMaxima"
                required>
              <span class="error-message" *ngIf="touched.fechaFin && errores.fechaFin">
                {{ errores.fechaFin }}
              </span>
            </div>
          </div>
        </div>

        <!-- Horarios -->
        <div class="form-section">
          <h3 class="section-title">Horario</h3>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="horaInicio">
                Hora de inicio
                <span class="required">*</span>
              </label>
              <input 
                type="time" 
                id="horaInicio" 
                name="horaInicio" 
                class="form-input"
                [class.input-valid]="getFieldStatus('horaInicio') === 'valid'"
                [class.input-invalid]="getFieldStatus('horaInicio') === 'invalid'"
                [(ngModel)]="horaInicio"
                (blur)="marcarTocado('horaInicio')"
                (change)="validarFormularioCompleto()"
                required>
              <span class="error-message" *ngIf="touched.horaInicio && errores.horaInicio">
                {{ errores.horaInicio }}
              </span>
            </div>

            <div class="form-group">
              <label class="form-label" for="horaFin">
                Hora de fin
                <span class="required">*</span>
              </label>
              <input 
                type="time" 
                id="horaFin" 
                name="horaFin" 
                class="form-input"
                [class.input-valid]="getFieldStatus('horaFin') === 'valid'"
                [class.input-invalid]="getFieldStatus('horaFin') === 'invalid'"
                [(ngModel)]="horaFin"
                (blur)="marcarTocado('horaFin')"
                (change)="validarFormularioCompleto()"
                required>
              <span class="error-message" *ngIf="touched.horaFin && errores.horaFin">
                {{ errores.horaFin }}
              </span>
            </div>
          </div>
        </div>

        <!-- Método de Pago -->
        <div class="form-section">
          <h3 class="section-title">Método de Pago</h3>
          <div class="payment-options">
            <label class="radio-option">
              <input 
                type="radio" 
                name="metodoPago" 
                value="Efectivo" 
                [(ngModel)]="metodoPago">
              <span class="radio-label">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Efectivo
              </span>
            </label>

            <label class="radio-option">
              <input 
                type="radio" 
                name="metodoPago" 
                value="Transferencia" 
                [(ngModel)]="metodoPago">
              <span class="radio-label">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
                Transferencia
              </span>
            </label>
          </div>
        </div>

        <!-- Resumen -->
        <div class="reservation-summary">
          <div class="summary-header">
            <h3 class="summary-title">Resumen de Reserva</h3>
            <button 
              type="button" 
              class="btn-limpiar"
              (click)="limpiarFormulario()"
              [disabled]="validandoDisponibilidad"
              title="Limpiar formulario">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Limpiar
            </button>
          </div>

          <div class="summary-content">
            <div class="summary-item">
              <span class="summary-label">Espacio:</span>
              <span class="summary-value">{{ espacioNombre || 'Espacio ' + espacioId }}</span>
            </div>

            <div class="summary-item">
              <span class="summary-label">Duración:</span>
              <span class="summary-value" [class.text-error]="calcularDuracion() === 'Horario inválido'">
                {{ calcularDuracion() }}
              </span>
            </div>

            <div class="summary-item">
              <span class="summary-label">Precio por hora:</span>
              <span class="summary-value">${{ espacioPrecio || 50 }}</span>
            </div>

            <div class="summary-item">
              <span class="summary-label">Método de pago:</span>
              <span class="summary-value">{{ metodoPago }}</span>
            </div>

            <div class="summary-item summary-total">
              <span class="summary-label">Total estimado:</span>
              <span class="summary-value">${{ calcularTotal() }}</span>
            </div>
          </div>
        </div>

        <!-- Mensaje de ayuda cuando el botón está deshabilitado -->
        <div class="help-message" *ngIf="!esFormularioValido() && (touched.fechaInicio || touched.fechaFin || touched.horaInicio || touched.horaFin)">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>{{ getMensajeBotonDeshabilitado() }}</span>
        </div>
      </form>
    </div>

    <!-- Actions -->
    <div class="modal-actions">
      <button 
        type="button" 
        class="btn-modal btn-cancelar" 
        (click)="cerrar()" 
        [disabled]="validandoDisponibilidad">
        Cancelar
      </button>
      <button 
        type="submit" 
        class="btn-modal btn-confirmar"
        [disabled]="!esFormularioValido() || validandoDisponibilidad" 
        [title]="getMensajeBotonDeshabilitado()"
        (click)="reservar()">
        <span *ngIf="!validandoDisponibilidad" class="btn-content">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Confirmar Reserva
        </span>
        <span *ngIf="validandoDisponibilidad" class="btn-content">
          <span class="spinner"></span>
          Validando...
        </span>
      </button>
    </div>
  </div>
</div>

<app-form-login [isVisibleForm]="mostrarLogin" (visibilityChange)="mostrarLogin = $event">
</app-form-login>